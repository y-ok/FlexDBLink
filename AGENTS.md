# 背景

このファイルは、AI が本リポジトリで作業する際に常時参照するルールです。  
目的は、品質・保守性・安全性を維持しつつ、判断基準を短く一貫した形で示すことです。

## 基本方針

### 品質と設計

- 動作だけでなく、品質・保守性・安全性を常に考慮する。
- 現在のフェーズ（プロトタイプ / MVP / 本番）に応じて、適切な品質水準を選ぶ。
- 問題は放置せず、修正するか、少なくとも明示的に記録する。
- ボーイスカウトルールに従い、触れた箇所はより良い状態で残す。
- DRY を守り、単一の信頼できる情報源を維持する。
- 命名は意図が伝わるものにし、スタイルはプロジェクト全体で統一する。
- 小さな不整合も放置せず修正する。
- コメントは「なぜ」を補足し、「何を」はコードで表現する。
- 機能追加時は既存コードの改善も検討する。
- 大きな変更は小さな段階に分ける。
- 未使用コードは積極的に削除する。
- 技術的負債はコメントやドキュメントで明示する。
- YAGNI を守る。
- 可読性を優先し、わかりづらい実装のみ簡潔に補足する。
- 三項演算子は使わない。
- 防御的な実装はしない。

### エラー処理と信頼性

- 関連が薄く見えるエラーも放置せず解決する。
- 例外を握りつぶさず、根本原因を修正する。
- エラーは早期検出し、明確なメッセージを出す。
- エラーケースもテスト対象に含める。
- 外部 API / ネットワークは失敗を前提に設計する。
- タイムアウトを適切に設定する。
- 必要に応じてリトライ（指数バックオフ含む）を検討する。
- 必要に応じてサーキットブレーカーパターンを活用する。
- 一時障害に耐えられる設計にする。
- 適切なログとメトリクスで可観測性を確保する。

### テストと検証

- テストはスキップせず、問題があれば原因を特定して修正する。
- 実装詳細ではなく振る舞いを検証する。
- テスト間の依存をなくし、任意順で実行可能にする。
- テストは高速かつ再現性を持たせる。
- カバレッジは指標であり、質を優先する。
- エラーやビルド失敗は成功するまで処置する。

### セキュリティ・性能・依存管理

- 秘密情報は環境変数で扱い、ハードコードしない。
- すべての外部入力を検証する。
- 最小権限で動作させる。
- 不要な依存は追加しない。
- 依存はライセンス、サイズ、保守状況を確認してから追加する。
- 依存はセキュリティ修正・バグ修正のため定期更新する。
- セキュリティ監査ツールは定期的に実行する。
- 最適化は推測ではなく計測に基づいて行う。
- 初期段階から拡張性を意識する。
- 必要になるまでリソース読み込みを遅延させる。
- キャッシュは期限と無効化戦略を明確にする。
- N+1 やオーバーフェッチを避ける。

### 開発運用

- ビジネス要件と技術要件のバランスを取る。
- 時間制約下でも最低限の品質基準は守る。
- チームの技術レベルに合う実装を選ぶ。
- すべてを完璧にはできない前提で、制約下の最適解を選ぶ。
- プロトタイプでは簡潔さ、本番では堅牢性をより重視する。
- 妥協点と理由は明文化する。
- コンベンショナルコミットを使用する（`.gitmessage.txt` 参照）。
- コミットは原子的にし、単一の変更に集中させる。
- コミットメッセージは明確な英語で書く。
- `main` へ直接コミットしない。
- レビューはコードに対して行い、建設的提案として扱う。
- 変更理由と影響を明確に説明する。
- フィードバックは学習機会として扱う。
- デバッグは再現手順確立、二分探索、最近の変更確認を基本とする。
- 必要に応じてデバッガーやプロファイラーを使う。
- 調査結果と解決策は記録し、再利用可能にする。
- README には概要、セットアップ、利用方法を明確に書く。
- ドキュメントはコード変更に追随させる。
- 実例を優先する。
- 重要な設計判断は ADR で記録する。
- 学んだことは次の作業に活かし、定期的に改善する。
- 新しいツールや手法は適切に評価して取り入れる。
- チームや将来の開発者のために知識を文書化する。

## 禁止事項

- 許可なくファイルやフォルダを削除しない。
- `AGENTS.md` と同等の領域にあるファイル / フォルダのみアクセス対象とする。
- テストコードで `setAccessible` を使わない。
- private メソッドを直接テストしない。public API 経由で C0 / C1 100% を目指す。
- public API 経由でカバーできない場合は、プロダクションコードの構造を見直す。

## プロジェクト固有ルール

### コミュニケーション

- 対話は日本語で行う。
- ただし、プロジェクト内のコメント、JavaDoc、README、コミットメッセージ、PR 説明などの成果物テキストは英語で統一する。

### 実装規約

- Java 11、Spring Boot 2.7.18 に準拠する。
- `pom.xml` に定義済みの OSS ライブラリを活用する。
- 改修時は未使用の field / local variable / import を残さない。
- `The value of the field xxx is not used` を含む未使用警告は 0 件にして完了とする。

### テスト・ビルド

- 新規作成や改修を行った場合は、原則として `mvn clean test` を実行して検証する。
- ただし、体裁修正のみ、テストコード変更なし、実行結果が変わらない変更は実行しない。
- テスト実行前に、変更を「ロジック変更 / 設定変更 / 体裁修正のみ」に分類して明示する。
- テスト実行前に、実行理由を 1 行で明示する。理由を明示できない場合は実行しない。
- テスト / ビルドが失敗した場合は、原因を特定し、成功するまで処置する。
- C0、C1 が 100% でない場合は、必要なテストケースを追加する。
- `mvn clean test` を実行した作業は、完了報告時に C0 / C1（INSTRUCTION / BRANCH）の実測値（% と covered / total）を必ず記載する。
- 実測値未記載のまま完了扱いにしない。
- 追加 / 修正 / 削除を行った作業でテストが失敗した場合は、分析して処置する。
- JUnit 5、mockit を使用する。

### テストメソッド命名

- テストメソッド名は `<メソッド名>_xxxケース_<検証内容>_<規格値>` とする。
- `xxx` には `正常` または `異常` を入れる。
- 規格値は必ず「〜であること」で統一する。
- 検証内容は、具体条件を動詞（〜する）で簡潔に表現する。
- 規格値は、名詞または結果表現で締める。
- 「〜する状態であること」は避け、可能な限り「〜が返る」「〜が設定される」「〜が再スローされる」などを名詞化して表現する。
- 検証内容は可能なら「〜すること」を付けずに記述し、補足が必要な場合はテスト内コメントで補う。

### リリース

- リリースタグは `pom.xml` の `<version>` と一致させる。
- タグ作成前に差分確認で `pom.xml` を必ず確認する。
- 対象コミットの CI（`ci.yml`）が全ジョブ成功してからタグを作成する。
- CI が失敗中または実行中の状態ではタグを作成しない。
- C0 / C1（INSTRUCTION / BRANCH）100% を `jacoco.xml` または CI ログで確認し、未達ならリリースしない。
- `main` への push 完了後に注釈付きタグを作成し、そのタグ push で `release.yml` を起動する。
- リリース完了条件は、`release.yml` 成功、GitHub Release 作成、想定 Assets 登録完了の 3 点確認とする。

### JavaDoc

- JavaDoc はすべて `/** ... */` 形式で記載する。
- テストコードを除き、private メソッドを含む全メソッドに簡潔な説明を付ける。
- 引数と戻り値には `@param` / `@return` を使い、意味や条件を具体的に記載する。
- 仕様、判定基準、例外、副作用の補足が必要な場合は、本文や `@throws` を使って明記する。

## このファイルの改善方針

- 現状の問題は、ルールの総量が増え、コンテキスト負荷が高くなっていること。
- そのため、今後も内容は維持しつつ、重複削減・章立て整理・表現統一を優先して更新する。
